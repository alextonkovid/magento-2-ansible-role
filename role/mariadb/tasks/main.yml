- name: Ensure MariaDB credentials are provided
  ansible.builtin.assert:
    that:
      - mariadb_root_password | length > 0
      - mariadb_user_password | length > 0
    fail_msg: >
      MariaDB root/application passwords must be supplied (store them securely via Ansible Vault).

- name: Validate admin credentials when requested
  ansible.builtin.assert:
    that:
      - mariadb_admin_password | length > 0
    fail_msg: >
      Set `mariadb_admin_password` (ideally via Vault) before enabling `mariadb_manage_admin_user`.
  when: mariadb_manage_admin_user | bool

- name: Install MariaDB prerequisites
  ansible.builtin.apt:
    name: "{{ mariadb_prereq_packages }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ mariadb_apt_cache_valid_time }}"

- name: Download MariaDB repository key
  ansible.builtin.get_url:
    url: "{{ mariadb_repo_key_url }}"
    dest: "{{ mariadb_repo_key_path }}"
    mode: '0644'

- name: Configure MariaDB repository
  ansible.builtin.deb822_repository:
    name: "{{ mariadb_repo_name }}"
    types: deb
    uris: "{{ mariadb_repo_url }}"
    suites: "{{ mariadb_repo_suite }}"
    components: "{{ mariadb_repo_components }}"
    architectures: "{{ mariadb_repo_architectures }}"
    signed_by: "{{ mariadb_repo_key_path }}"
    state: present

- name: Install MariaDB packages
  ansible.builtin.apt:
    name: "{{ mariadb_packages }}"
    state: present
    update_cache: true

- name: Deploy MariaDB configuration override
  ansible.builtin.template:
    src: "{{ mariadb_config_template }}"
    dest: "{{ mariadb_config_file }}"
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb

- name: Ensure MariaDB service is enabled and started
  ansible.builtin.service:
    name: "{{ mariadb_service_name }}"
    state: started
    enabled: true

- name: Create required MariaDB databases
  community.mysql.mysql_db:
    name: "{{ item.name }}"
    state: present
    encoding: "{{ item.encoding | default(omit) }}"
    collation: "{{ item.collation | default(omit) }}"
    login_user: root
    login_unix_socket: "{{ mariadb_socket }}"
  loop: "{{ mariadb_databases }}"

- name: Configure MariaDB root password for allowed hosts
  community.mysql.mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ mariadb_root_password }}"
    login_user: root
    login_unix_socket: "{{ mariadb_socket }}"
    check_implicit_admin: true
    state: present
  loop: "{{ mariadb_root_hosts }}"
  no_log: true

- name: Create MariaDB user accounts
  community.mysql.mysql_user:
    name: "{{ item.name }}"
    host: "{{ item.host | default('localhost') }}"
    password: "{{ item.password }}"
    priv: "{{ item.priv | default(omit) }}"
    login_user: root
    login_unix_socket: "{{ mariadb_socket }}"
    state: "{{ item.state | default('present') }}"
  loop: >-
    {{
      mariadb_users
      + (mariadb_manage_admin_user | bool | ternary([mariadb_admin_account], []))
      + mariadb_additional_users
    }}
  loop_control:
    label: "{{ item.name }}@{{ item.host | default('localhost') }}"
  no_log: true
