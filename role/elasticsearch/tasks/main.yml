---
- name: Install Elasticsearch prerequisites
  ansible.builtin.apt:
    name: "{{ elasticsearch_prereq_packages }}"
    state: present
    update_cache: true

- name: Download Elasticsearch repository key
  ansible.builtin.get_url:
    url: "{{ elasticsearch_repo_key_url }}"
    dest: "{{ elasticsearch_repo_key_path }}"
    mode: '0644'

- name: Configure Elasticsearch repository
  ansible.builtin.deb822_repository:
    name: "{{ elasticsearch_repo_name }}"
    types: deb
    uris: "{{ elasticsearch_repo_url }}"
    suites: "{{ elasticsearch_repo_suites }}"
    components: "{{ elasticsearch_repo_components }}"
    signed_by: "{{ elasticsearch_repo_key_path }}"
    state: present

- name: Install Elasticsearch packages
  ansible.builtin.apt:
    name: "{{ elasticsearch_packages }}"
    state: present
    update_cache: true

- name: Apply elasticsearch.yml overrides
  ansible.builtin.lineinfile:
    path: "{{ elasticsearch_config_path }}"
    regexp: "^{{ item.key | regex_escape() }}:"
    line: "{{ item.key }}: {{ item.value }}"
    state: present
    backup: true
  loop: "{{ elasticsearch_config_overrides }}"
  notify: restart elasticsearch

- name: Ensure Elasticsearch service is enabled and running
  ansible.builtin.systemd:
    name: "{{ elasticsearch_service_name }}"
    enabled: true
    state: started
